name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Set up Node.js 20.19.3
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.3

      - name: üöÄ Enable Corepack
        run: corepack enable

      - name: ‚öôÔ∏è Configure Git to prefer HTTPS for public repos (override SSH rewrite)
        run: |
          git config --global --unset-all url."git@github.com:".insteadOf || true
          git config --global --unset-all url.ssh://git@github.com/.insteadOf || true
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"

      - name: üì¶ Install dependencies (Yarn v3)
        run: yarn install --immutable

      # - name: Initialize vendor libs
      #   run: yarn aa:init

      - name: Debug Node Modules Resolution
        run: |
          echo "Listing contents of node_modules/@account-abstraction/contracts/core:"
          ls -R packages/hardhat/node_modules/@account-abstraction/contracts/core/ || echo "Path not found in working directory"
          echo "Absolute path to node_modules:"
          readlink -f packages/hardhat/node_modules/@account-abstraction/contracts/core/EntryPoint.sol || echo "File not found at readlink path"
        working-directory: packages/hardhat # Ensure this runs from the hardhat package dir

      - name: Force Hardhat Compile and Check Artifacts
        run: |
          echo "Running npx hardhat compile again explicitly..."
          npx hardhat compile # Run compile directly and watch for errors
          echo "Listing contents of generated artifacts for EntryPoint:"
          ls -R packages/hardhat/artifacts/@account-abstraction/contracts/core/ || echo "Artifacts path not found or empty"
          echo "Checking for specific EntryPoint artifact file:"
          ls packages/hardhat/artifacts/@account-abstraction/contracts/core/EntryPoint.sol/EntryPoint.json || echo "Specific EntryPoint artifact not found"
        working-directory: packages/hardhat

      - name: Load fallback .env
        run: cp packages/hardhat/.env.example packages/hardhat/.env

      - name: Compile contracts
        run: yarn compile
        working-directory: packages/hardhat

      - name: üöÄ Run Hardhat Local Tests
        run: yarn test
        working-directory: packages/hardhat

      - name: üìä Run Test Coverage
        run: yarn test:coverage
        working-directory: packages/hardhat

      - name: üìà Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: packages/hardhat/coverage/
          retention-days: 7

      - name: ‚úÖ Check GasXERC20FeePaymaster Coverage
        run: |
          # Extract coverage for GasXERC20FeePaymaster
          STMT_COV=$(cat coverage/coverage-final.json | node -e "
            const data = require('fs').readFileSync('/dev/stdin', 'utf8');
            const json = JSON.parse(data);
            const file = Object.keys(json).find(k => k.includes('GasXERC20FeePaymaster.sol'));
            if (!file) { console.log('0'); process.exit(0); }
            const f = json[file];
            const stmts = Object.values(f.s);
            const covered = stmts.filter(v => v > 0).length;
            console.log(Math.round((covered / stmts.length) * 100));
          ")
          echo "GasXERC20FeePaymaster Statement Coverage: ${STMT_COV}%"
          if [ "$STMT_COV" -lt 95 ]; then
            echo "‚ùå Coverage below 95% threshold!"
            exit 1
          fi
          echo "‚úÖ Coverage meets threshold"
        working-directory: packages/hardhat

      - name: üîê Verify secrets for public network tests
        env:
          # Necesita los mismos secretos que el paso de prueba
          DEPLOYER_PRIVATE_KEY_ENCRYPTED: ${{ secrets.DEPLOYER_PRIVATE_KEY_ENCRYPTED }}
          DEPLOYER_PASSWORD: ${{ secrets.DEPLOYER_PASSWORD }}
        run: yarn verify-key
        working-directory: packages/hardhat

      - name: üöÄ Run Hardhat Scroll Sepolia Tests
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
          PIMLICO_API_KEY: ${{ secrets.PIMLICO_API_KEY }}
          DEPLOYER_PRIVATE_KEY_ENCRYPTED: ${{ secrets.DEPLOYER_PRIVATE_KEY_ENCRYPTED }}
          DEPLOYER_PASSWORD: ${{ secrets.DEPLOYER_PASSWORD }}
        run: |
          yarn test --network scrollSepolia
        working-directory: packages/hardhat

  slither:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20.19.3
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.3

      - name: Enable Corepack
        run: corepack enable

      - name: Configure Git HTTPS
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Load fallback .env
        run: cp packages/hardhat/.env.example packages/hardhat/.env

      - name: Compile contracts
        run: yarn compile
        working-directory: packages/hardhat

      - name: Run Slither Analysis
        uses: crytic/slither-action@v0.4.0
        id: slither
        with:
          target: packages/hardhat
          slither-config: packages/hardhat/slither.config.json
          fail-on: high
          sarif: results.sarif
        continue-on-error: true

      - name: Upload Slither SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        if: always()

      - name: Check Slither Results
        run: |
          if [ "${{ steps.slither.outcome }}" == "failure" ]; then
            echo "Slither found high severity issues!"
            exit 1
          fi
          echo "Slither analysis passed"
